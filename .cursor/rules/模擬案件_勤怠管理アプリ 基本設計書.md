# ルート・コントローラー仕様書

## 一般ユーザー向けルート

| No. | 画面名称 | パス | メソッド | ルート名 | コントローラー | アクション | 認証必須 | ミドルウェア | Bladeファイル | 備考 |
|-----|---------|------|---------|---------|------------|----------|---------|------------|--------------|------|
| 1 | 会員登録画面(一般ユーザー) | /register | GET/POST | register / - | Fortifyで自動生成 | - | × | guest | auth/register.blade.php | FN001-FN005 |
| 2 | ログイン画面(一般ユーザー) | /login | GET/POST | login / - | Fortifyで自動生成 | - | × | guest | auth/login.blade.php | FN006-FN010 |
| 3 | 出勤登録画面(一般ユーザー) | /attendance | GET/POST | attendance.index / attendance.store | AttendanceController | index / store | ○ | auth, verified | home.blade.php | FN018-FN022 |
| 4 | 勤怠一覧画面(一般ユーザー) | /attendance/list | GET | attendance.list | AttendanceController | list | ○ | auth, verified | list.blade.php | FN023-FN025 |
| 5 | 勤怠詳細画面(一般ユーザー) | /attendance/detail/{id} | GET/POST | attendance.show / attendance.update | AttendanceController | show / update | ○ | auth, verified | show.blade.php | FN026-FN030 |
| 6 | 申請一覧画面(一般ユーザー) | /stamp_correction_request/list | GET | correction.index | StampCorrectionRequestController | index | ○ | auth, verified | stampCorrectionRequest.blade.php | FN031-FN036<br/>**一般/管理者共通** |

## 管理者向けルート

| No. | 画面名称 | パス | メソッド | ルート名 | コントローラー | アクション | 認証必須 | ミドルウェア | Bladeファイル | 備考 |
|-----|---------|------|---------|---------|------------|----------|---------|------------|--------------|------|
| 7 | ログイン画面(管理者) | /admin/login | GET/POST | admin.login / - | Fortifyで自動生成 | - | × | guest:admin | auth/adminLogin.blade.php | FN014-FN016 |
| 8 | 勤怠一覧画面(管理者) | /admin/attendance/list | GET | admin.index | AdminController | index | ○ | auth:admin | admin/index.blade.php | FN034 |
| 9 | 勤怠詳細画面(管理者) | /admin/attendance/{id} | GET | admin.show | AdminController | show | ○ | auth:admin | admin/dailyShow.blade.php | FN026 |
| 10 | スタッフ一覧画面(管理者) | /admin/staff/list | GET | admin.staff | AdminController | staff | ○ | auth:admin | admin/staffList.blade.php | FN041 |
| 11 | スタッフ別勤怠一覧画面(管理者) | /admin/attendance/staff/{id} | GET | admin.list | AdminController | list | ○ | auth:admin | admin/monthlyShow.blade.php | FN042-FN046 |
| 12 | 申請一覧画面(管理者) | /stamp_correction_request/list | GET | correction.index | StampCorrectionRequestController | index | ○ | auth:admin | stampCorrectionRequest.blade.php | FN047-FN049<br/>**一般/管理者共通** |
| 13 | 修正申請承認画面(管理者) | /stamp_correction_request/approve/{attendance_correct_request_id} | GET/POST | correction.show / correction.update | StampCorrectionRequestController | show / update | ○ | auth:admin | admin/approval.blade.php | FN050-FN051 |

---

## Bladeファイル構成

```
resources/views/
├── auth/
│   ├── register.blade.php              # 会員登録画面(一般ユーザー)
│   ├── login.blade.php                 # ログイン画面(一般ユーザー)
│   └── adminLogin.blade.php            # ログイン画面(管理者)
│
├── home.blade.php                      # 出勤登録画面(一般ユーザー)
├── list.blade.php                      # 勤怠一覧画面(一般ユーザー)
├── show.blade.php                      # 勤怠詳細画面(一般ユーザー)
├── stampCorrectionRequest.blade.php    # 申請一覧画面(一般/管理者共通)
│
└── admin/
    ├── index.blade.php                 # 勤怠一覧画面(管理者)
    ├── dailyShow.blade.php             # 勤怠詳細画面(管理者)
    ├── staffList.blade.php             # スタッフ一覧画面(管理者)
    ├── monthlyShow.blade.php           # スタッフ別勤怠一覧画面(管理者)
    └── approval.blade.php              # 修正申請承認画面(管理者)
```

---

## 詳細仕様

### 1. 会員登録画面(一般ユーザー) - /register

#### GET /register
- **コントローラー**: Fortifyで自動生成
- **Bladeファイル**: `resources/views/auth/register.blade.php`
- **機能**: 新規会員登録フォームの表示
- **対応機能**: FN001

#### POST /register
- **処理**: Fortifyで自動生成
- **バリデーション**: FN001-FN003
  - 氏名: 必須、文字列、最大255文字
  - メールアドレス: 必須、メール形式、ユニーク
  - パスワード: 必須、8文字以上、確認用と一致
- **対応機能**: FN001-FN005
- **登録後の処理**: メール認証メール送信(FN011)

---

### 2. ログイン画面(一般ユーザー) - /login

#### GET /login
- **コントローラー**: Fortifyで自動生成
- **Bladeファイル**: `resources/views/auth/login.blade.php`
- **機能**: ログインフォームの表示
- **対応機能**: FN006

#### POST /login
- **処理**: Fortifyで自動生成
- **バリデーション**: FN007-FN009
  - メールアドレス: 必須、メール形式
  - パスワード: 必須
- **対応機能**: FN006-FN010
- **ログイン後の遷移**: 出勤登録画面(メール認証済みの場合)

---

### 3. 出勤登録画面(一般ユーザー) - /attendance

#### GET /attendance
- **コントローラー**: AttendanceController
- **アクション**: index
- **Bladeファイル**: `resources/views/home.blade.php`
- **機能**: 当日の勤怠情報と打刻ボタンの表示
- **処理内容**:
  - 当日の勤怠レコード取得
  - 現在のステータス判定(FN019)
  - 打刻ボタン表示制御(FN020-FN022)
  - 日時情報表示(FN018)
- **渡すデータ**:
  - `attendance`: 当日の勤怠レコード
  - `status`: 現在のステータス(未出勤/出勤中/休憩中/退勤済)
- **対応機能**: FN018-FN019

#### POST /attendance
- **アクション**: store
- **機能**: 打刻処理(出勤・退勤・休憩開始・休憩終了)
- **リクエストデータ**:
  - `stamp_type`: 'clock_in' / 'clock_out' / 'break_start' / 'break_end'
- **処理内容**:
  - 出勤打刻: ステータス更新、出勤時刻記録
  - 休憩開始打刻: 休憩時刻記録
  - 休憩終了打刻: 休憩終了時刻記録
  - 退勤打刻: 退勤時刻記録
- **バリデーション**: ステータス遷移、時刻整合性チェック
- **対応機能**: FN020-FN022, FN028-FN029

---

### 4. 勤怠一覧画面(一般ユーザー) - /attendance/list

#### GET /attendance/list
- **コントローラー**: AttendanceController
- **アクション**: list
- **Bladeファイル**: `resources/views/list.blade.php`
- **機能**: 自分の勤怠一覧表示
- **処理内容**:
  - 自分の勤怠情報を月別・日別に取得(FN023)
  - 月次情報表示機能(出勤時刻・退勤時刻・休憩時間・実働時間)(FN024)
  - 詳細連携機能(FN025)
- **渡すデータ**:
  - `attendances`: 勤怠レコードのコレクション
  - `currentMonth`: 現在表示中の月
- **対応機能**: FN023-FN025

---

### 5. 勤怠詳細画面(一般ユーザー) - /attendance/detail/{id}

#### GET /attendance/detail/{id}
- **コントローラー**: AttendanceController
- **アクション**: show
- **Bladeファイル**: `resources/views/show.blade.php`
- **機能**: 特定日の勤怠詳細情報表示
- **処理内容**:
  - 勤怠レコード詳細取得
  - 自分の勤怠レコードであることを確認
  - 日付、出勤時刻、退勤時刻、休憩時間表示(FN026)
  - 項目編集機能(FN027)
  - 修正申請ボタン表示(FN030)
- **渡すデータ**:
  - `attendance`: 勤怠レコード
  - `canEdit`: 編集可能フラグ
- **対応機能**: FN026-FN027

#### POST /attendance/detail/{id}
- **アクション**: update
- **機能**: 修正申請の作成
- **リクエストデータ**:
  - `corrected_clock_in`: 修正後出勤時刻
  - `corrected_clock_out`: 修正後退勤時刻
  - `corrected_break_time`: 修正後休憩時間
  - `note`: 備考(必須)
- **処理内容**:
  - 修正申請レコード作成(FN030)
- **バリデーション**: note(備考)必須、時刻妥当性チェック
- **対応機能**: FN030

---

### 6. 申請一覧画面(一般ユーザー/管理者共通) - /stamp_correction_request/list

#### GET /stamp_correction_request/list
- **コントローラー**: StampCorrectionRequestController
- **アクション**: index
- **Bladeファイル**: `resources/views/stampCorrectionRequest.blade.php`
- **機能**: 修正申請一覧表示(一般ユーザー/管理者共通)
- **認証ミドルウェアによる表示振り分け**:
  - 一般ユーザー: 自分の申請のみ表示
  - 管理者: 全ユーザーの申請表示
- **処理内容**:
  - 一般ユーザー: ログインユーザーの申請一覧取得(FN031-FN036)
  - 管理者: 全ユーザーの申請一覧取得(FN047-FN049)
  - 承認待ち/承認済み情報の表示: 'approved_at'の有無で判定
  - 申請詳細への遷移
- **渡すデータ**:
  - `requests`: 申請のコレクション(承認待ち・承認済み含む)
  - `isAdmin`: 管理者フラグ
- **対応機能**: FN031-FN036(一般), FN047-FN049(管理者)

---

### 7. ログイン画面(管理者) - /admin/login

#### GET /admin/login
- **コントローラー**: Fortifyで自動生成(adminガード用)
- **Bladeファイル**: `resources/views/auth/adminLogin.blade.php`
- **機能**: 管理者ログインフォームの表示
- **対応機能**: FN014

#### POST /admin/login
- **処理**: Fortifyで自動生成(adminガード用)
- **バリデーション**: FN015-FN016
  - メールアドレス: 必須、メール形式
  - パスワード: 必須
- **対応機能**: FN014-FN016
- **ログイン後の遷移**: 勤怠一覧画面(管理者)

---

### 8. 勤怠一覧画面(管理者) - /admin/attendance/list

#### GET /admin/attendance/list
- **コントローラー**: AdminController
- **アクション**: index
- **Bladeファイル**: `resources/views/admin/index.blade.php`
- **機能**: 全ユーザーの日次勤怠一覧表示
- **処理内容**:
  - 全ユーザーの勤怠情報取得(FN034)
  - カラム単位での並び替え機能
  - 勤怠詳細への遷移
- **渡すデータ**:
  - `attendances`: 全ユーザーの勤怠レコード
  - `currentDate`: 現在表示中の日付
- **対応機能**: FN034

---

### 9. 勤怠詳細画面(管理者) - /admin/attendance/{id}

#### GET /admin/attendance/{id}
- **コントローラー**: AdminController
- **アクション**: show
- **Bladeファイル**: `resources/views/admin/dailyShow.blade.php`
- **機能**: 特定ユーザーの特定日の日次勤怠詳細表示
- **処理内容**:
  - 勤怠レコード詳細取得
  - ユーザー情報、日付、出退勤時刻、休憩時間表示(FN026)
  - 修正申請情報表示
- **渡すデータ**:
  - `attendance`: 勤怠レコード
  - `user`: ユーザー情報
  - `correctionRequest`: 修正申請情報(ある場合)
- **対応機能**: FN026

---

### 10. スタッフ一覧画面(管理者) - /admin/staff/list

#### GET /admin/staff/list
- **コントローラー**: AdminController
- **アクション**: staff
- **Bladeファイル**: `resources/views/admin/staffList.blade.php`
- **機能**: 全スタッフの一覧表示
- **処理内容**:
  - 全ユーザー情報取得(FN041)
  - 氏名、メールアドレス表示
  - カラム単位での並び替え
  - スタッフ別勤怠一覧への遷移
- **渡すデータ**:
  - `users`: 全ユーザーのコレクション
- **対応機能**: FN041

---

### 11. スタッフ別勤怠一覧画面(管理者) - /admin/attendance/staff/{id}

#### GET /admin/attendance/staff/{id}
- **コントローラー**: AdminController
- **アクション**: list
- **Bladeファイル**: `resources/views/admin/monthlyShow.blade.php`
- **機能**: 特定スタッフの月別勤怠一覧表示とCSV出力
- **パラメータ**: 
  - `id`: ユーザーID
  - `month`: 対象月(クエリパラメータ、デフォルト: 当月)
  - `download`: CSV出力フラグ(クエリパラメータ)
- **処理内容**:
  - 指定ユーザーの指定月の勤怠情報取得(FN042)
  - カラム単位での並び替え(FN043)
  - 月表示変更機能(FN044)
  - CSV出力機能(FN045)
  - 詳細連携機能(FN046)
- **渡すデータ**:
  - `user`: ユーザー情報
  - `attendances`: 勤怠レコードのコレクション
  - `currentMonth`: 表示中の月
- **対応機能**: FN042-FN046

#### CSVエクスポート機能
- **トリガー**: `?download=csv`
- **出力項目**: 日付、出勤時刻、退勤時刻、休憩時間、実働時間
- **ファイル名**: `attendance_{user_id}_{YYYYMM}.csv`
- **文字コード**: UTF-8 BOM付き

---

### 12. 申請一覧画面(管理者) - /stamp_correction_request/list

No.6と同一画面(認証ミドルウェアで表示を動的に振り分け)

---

### 13. 修正申請承認画面(管理者) - /stamp_correction_request/approve/{attendance_correct_request_id}

#### GET /stamp_correction_request/approve/{attendance_correct_request_id}
- **コントローラー**: StampCorrectionRequestController
- **アクション**: show
- **Bladeファイル**: `resources/views/admin/approval.blade.php`
- **機能**: 修正申請詳細と承認フォーム表示
- **処理内容**:
  - 修正申請詳細取得(FN050)
  - 申請者情報、元の勤怠情報、修正内容、備考表示
  - 承認ボタン表示(却下機能は無し)
- **渡すデータ**:
  - `request`: 修正申請レコード
  - `attendance`: 元の勤怠レコード
  - `user`: 申請者情報
- **対応機能**: FN050

#### POST /stamp_correction_request/approve/{attendance_correct_request_id}
- **アクション**: update
- **機能**: 修正申請の承認処理(却下機能は無し)
- **リクエストデータ**:
  - `corrected_clock_in`: 修正後出勤時刻
  - `corrected_clock_out`: 修正後退勤時刻
  - `corrected_break_time`: 修正後休憩時間
  - `note`: 備考(任意)
- **処理内容**(FN051):
  - 元の勤怠レコードの時刻を修正後の値に更新
  - `approved_by`に管理者IDを設定
  - `approved_at`に現在日時を設定
- **リダイレクト**: 申請一覧画面
- **対応機能**: FN051

---

## コントローラー一覧

### AttendanceController
| アクション | メソッド | 機能 | 対応画面 |
|----------|---------|------|---------|
| index | GET | 出勤登録画面表示 | No.3 |
| store | POST | 打刻処理 | No.3 |
| list | GET | 勤怠一覧表示 | No.4 |
| show | GET | 勤怠詳細表示 | No.5 |
| update | POST | 修正申請作成 | No.5 |

### StampCorrectionRequestController
| アクション | メソッド | 機能 | 対応画面 |
|----------|---------|------|---------|
| index | GET | 申請一覧表示(一般/管理者共通) | No.6, No.12 |
| show | GET | 修正申請承認画面表示 | No.13 |
| update | POST | 修正申請承認処理 | No.13 |

### AdminController
| アクション | メソッド | 機能 | 対応画面 |
|----------|---------|------|---------|
| index | GET | 日次勤怠一覧表示 | No.8 |
| show | GET | 日次勤怠詳細表示 | No.9 |
| staff | GET | スタッフ一覧表示 | No.10 |
| list | GET | 月次勤怠一覧表示・CSV出力 | No.11 |

---

## routes/web.php 実装例

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\AttendanceController;
use App\Http\Controllers\StampCorrectionRequestController;
use App\Http\Controllers\AdminController;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

// 一般ユーザー向けルート
Route::middleware(['auth', 'verified'])->group(function () {
    // 出勤登録画面 (No.3)
    Route::get('/attendance', [AttendanceController::class, 'index'])
        ->name('attendance.index');
    Route::post('/attendance', [AttendanceController::class, 'store'])
        ->name('attendance.store');
    
    // 勤怠一覧画面 (No.4)
    Route::get('/attendance/list', [AttendanceController::class, 'list'])
        ->name('attendance.list');
    
    // 勤怠詳細画面・修正申請作成 (No.5)
    Route::get('/attendance/detail/{id}', [AttendanceController::class, 'show'])
        ->name('attendance.show');
    Route::post('/attendance/detail/{id}', [AttendanceController::class, 'update'])
        ->name('attendance.update');
    
    // 申請一覧画面 (No.6) - 一般ユーザー/管理者共通
    Route::get('/stamp_correction_request/list', [StampCorrectionRequestController::class, 'index'])
        ->name('correction.index');
});

// 管理者向けルート
Route::prefix('admin')->middleware(['auth:admin'])->group(function () {
    // 勤怠一覧画面 (No.8)
    Route::get('/attendance/list', [AdminController::class, 'index'])
        ->name('admin.index');
    
    // 勤怠詳細画面 (No.9)
    Route::get('/attendance/{id}', [AdminController::class, 'show'])
        ->name('admin.show');
    
    // スタッフ一覧画面 (No.10)
    Route::get('/staff/list', [AdminController::class, 'staff'])
        ->name('admin.staff');
    
    // スタッフ別勤怠一覧画面・CSV出力 (No.11)
    Route::get('/attendance/staff/{id}', [AdminController::class, 'list'])
        ->name('admin.list');
    
    // 申請一覧画面 (No.12) - 一般ユーザー/管理者共通
    Route::get('/stamp_correction_request/list', [StampCorrectionRequestController::class, 'index'])
        ->name('correction.index');
    
    // 修正申請承認画面 (No.13)
    Route::get('/stamp_correction_request/approve/{attendance_correct_request_id}', [StampCorrectionRequestController::class, 'show'])
        ->name('correction.show');
    Route::post('/stamp_correction_request/approve/{attendance_correct_request_id}', [StampCorrectionRequestController::class, 'update'])
        ->name('correction.update');
});
```

---

## 実装上の注意事項

### 1. 会員登録・ログイン (No.1, No.2, No.7)
Fortifyがデフォルトでルートとコントローラーを自動生成するため、上記のroutes/web.phpには記載不要です。
Fortifyの設定は`config/fortify.php`と`app/Providers/FortifyServiceProvider.php`で行います。

### 2. 申請一覧画面 (No.6, No.12)
一般ユーザーと管理者で同一パス・同一コントローラー・同一アクションを使用します。
コントローラー内で認証ガードを判定し、データ取得ロジックとBlade表示を動的に切り替えます。

```php
// StampCorrectionRequestController::index の実装例
public function index()
{
    if (Auth::guard('admin')->check()) {
        // 管理者: 全ユーザーの申請を取得
        $pendingRequests = StampCorrectionRequest::whereNull('approved_at')->get();
        $approvedRequests = StampCorrectionRequest::whereNotNull('approved_at')->get();
        $isAdmin = true;
    } else {
        // 一般ユーザー: 自分の申請のみ取得
        $pendingRequests = StampCorrectionRequest::where('user_id', Auth::id())
            ->whereNull('approved_at')->get();
        $approvedRequests = StampCorrectionRequest::where('user_id', Auth::id())
            ->whereNotNull('approved_at')->get();
        $isAdmin = false;
    }
    
    return view('stampCorrectionRequest', compact('pendingRequests', 'approvedRequests', 'isAdmin'));
}
```

### 3. CSV出力 (No.11)
スタッフ別勤怠一覧画面では、クエリパラメータ`download=csv`の有無でCSV出力と通常表示を切り替えます。

```php
// AdminController::list の実装例
public function list($id, Request $request)
{
    // データ取得処理
    
    if ($request->get('download') === 'csv') {
        // CSV出力処理
        return $this->exportCsv($user, $attendances, $currentMonth);
    }
    
    // 通常表示
    return view('admin.monthlyShow', compact('user', 'attendances', 'currentMonth'));
}
```

### 4. 休憩時間の扱い
- 休憩開始・休憩終了の打刻は何度でも可能
- 勤怠一覧画面(一般ユーザー)・勤怠一覧画面(管理者)・スタッフ別勤怠一覧画面(管理者)・CSV出力情報では、休憩時間は合計時間として表示します（例: 01:00）
```