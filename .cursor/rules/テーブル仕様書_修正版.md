# テーブル仕様書

---

## 1. users(ユーザー)

| No. | テーブル名 | カラム名                     | 型                       | PRIMARY KEY | UNIQUE KEY | NOT NULL | FOREIGN KEY | 備考                                                                                                     |
| --- | ---------- | ---------------------------- | ------------------------ | ----------- | ---------- | -------- | ----------- | -------------------------------------------------------------------------------------------------------- |
| 1   | users      | id                           | BIGINT UNSIGNED          | ●           |            | ●        |             | 主キー、自動採番                                                                                         |
|     |            | name                         | VARCHAR(255)             |             |            | ●        |             | 氏名                                                                                                     |
|     |            | email                        | VARCHAR(255)             |             | ●          | ●        |             | メールアドレス                                                                                           |
|     |            | email_verified_at            | TIMESTAMP                |             |            |          |             | メール認証完了日時                                                                                       |
|     |            | password                     | VARCHAR(255)             |             |            | ●        |             | パスワード(ハッシュ化)                                                                                   |
|     |            | role                         | ENUM('general', 'admin') |             |            | ●        |             | ユーザー権限<br/>general:一般ユーザー<br/>admin:管理者                                                   |
|     |            | department_code              | INTEGER                  |             |            |          |             | 部門コード<br/>1: 全アクセス権限(role='admin'の場合)<br/>2 以降: 部門コード(role='admin'または'general') |
|     |            | verification_code            | VARCHAR(6)               |             |            |          |             | メール認証コード(6 桁)                                                                                   |
|     |            | verification_code_expires_at | TIMESTAMP                |             |            |          |             | 認証コード有効期限                                                                                       |
|     |            | remember_token               | VARCHAR(100)             |             |            |          |             | ログイン保持トークン                                                                                     |
|     |            | created_at                   | TIMESTAMP                |             |            | ●        |             | 作成日時                                                                                                 |
|     |            | updated_at                   | TIMESTAMP                |             |            | ●        |             | 更新日時                                                                                                 |

**説明**: ユーザーの基本情報を管理するテーブル。一般ユーザーと管理者を`role`カラムで区別し、`department_code`で部門ベースのアクセス制御を実現。Laravel Fortify による認証機能に対応し、メール認証に 6 桁の確認コードを使用。

**制約**:

- **ユニーク制約**: email - メールアドレスの重複防止

**権限管理**:

- `role = 'general'`: 一般ユーザー(デフォルト) - 自分の勤怠のみ参照可能
- `role = 'admin'` + `department_code = 1`: 全アクセス権限 - 全ユーザーの勤怠を参照・修正・承認可能
- `role = 'admin'` + `department_code != 1`: 部門アクセス権限 - 同じ部門コードのメンバーの勤怠を参照・修正可能（自身の承認は不可）
- `role = 'admin'` + `department_code = NULL`: 管理者権限のみ（アクセス制御の対象外）

管理者の識別:
• users.role = 'admin': 管理者権限
• users.role = 'general': 一般ユーザー

**部門コードによるアクセス制御**:

- `department_code = 1` (role='admin'の場合): 全ユーザーの勤怠を参照・修正・承認可能
- `department_code != 1` (role='admin'の場合): 同じ部門コードのメンバーの勤怠を参照・修正可能（自身の承認は不可）
- `department_code != 1` (role='general'の場合): 一般ユーザー（自分の勤怠のみ参照可能）

**メール認証フロー**(一般ユーザーのみ):

1. ユーザー登録時に 6 桁の確認コードを生成し、`verification_code`に保存
2. 有効期限(30 分後)を`verification_code_expires_at`に保存
3. 確認コードをメールで送信
4. ユーザーが確認コードを入力
5. コードが一致し、有効期限内であれば`email_verified_at`に現在日時を記録
6. 認証完了後、`verification_code`と`verification_code_expires_at`を NULL にクリア

**確認コード再送信**:

- 新しい 6 桁コードを生成し、`verification_code`を上書き
- 新しい有効期限(30 分後)を`verification_code_expires_at`に設定

**対応機能**:

- FN001-FN005: 会員登録(一般ユーザー)
- FN006-FN010: ログイン(一般ユーザー)
- FN011-FN012: メール認証(一般ユーザー)
- FN013: ログアウト(一般ユーザー)
- FN014-FN017: 管理者ログイン・ログアウト(role='admin')
- FN041: スタッフ一覧情報取得(管理者機能)

**備考**:

- 一般ユーザーはメール認証必須、管理者はメール認証不要
- メール認証が完了していない一般ユーザーは、メール認証確認画面へ遷移する(FN005)
- 管理者の作成方法: シーダーで作成、またはデータベース操作で role を'admin'に変更

---

## 2. attendances(勤怠記録)

| No. | テーブル名  | カラム名         | 型              | PRIMARY KEY | UNIQUE KEY        | NOT NULL | FOREIGN KEY | 備考                              |
| --- | ----------- | ---------------- | --------------- | ----------- | ----------------- | -------- | ----------- | --------------------------------- |
| 2   | attendances | id               | BIGINT UNSIGNED | ●           |                   | ●        |             | 主キー、自動採番                  |
|     |             | user_id          | BIGINT UNSIGNED |             | ● (user_id, date) | ●        | users.id    | ユーザー ID<br/>※複合ユニーク制約 |
|     |             | date             | DATE            |             | ● (user_id, date) | ●        |             | 勤怠日<br/>※複合ユニーク制約      |
|     |             | clock_in         | TIME            |             |                   |          |             | 出勤時刻                          |
|     |             | clock_out        | TIME            |             |                   |          |             | 退勤時刻                          |
|     |             | note             | TEXT            |             |                   |          |             | 備考                              |
|     |             | last_modified_by | BIGINT UNSIGNED |             |                   |          | users.id    | 最終更新者(管理者の user_id)      |
|     |             | last_modified_at | TIMESTAMP       |             |                   |          |             | 最終更新日時                      |
|     |             | created_at       | TIMESTAMP       |             |                   | ●        |             | 作成日時                          |
|     |             | updated_at       | TIMESTAMP       |             |                   | ●        |             | 更新日時                          |

**説明**: 日次の勤怠情報を管理するテーブル。1 ユーザー 1 日 1 レコード。

**制約**:

- **複合ユニーク制約**: (user_id, date) - 1 ユーザーにつき 1 日 1 レコードのみ許可
- **外部キー制約**:
  - user_id → users.id (ON DELETE CASCADE, ON UPDATE CASCADE)
  - last_modified_by → users.id (ON DELETE SET NULL, ON UPDATE CASCADE)

**対応機能**:

- FN018-FN022: 日報情報取得・打刻機能(一般ユーザー)
- FN023-FN025: 勤怠一覧・月次情報表示(一般ユーザー)
- FN026-FN027: 詳細情報取得・項目編集(一般ユーザー)
- FN030: 修正申請(修正申請ボタンを押すと修正申請作成)
- FN034-FN036: 日次勤怠情報取得(管理者 - 全ユーザーの勤怠情報)
- FN037-FN040: 詳細情報取得・項目編集・修正機能(管理者による直接編集)
- FN042-FN046: 月次勤怠情報取得・CSV 出力(管理者)
- FN051: 承認処理(元の勤怠レコードを修正後の値に更新)

**備考**:

- 実働時間や休憩時間の合計は計算項目として扱い、テーブルには保存しない
- 打刻処理時、該当日のレコードが存在しない場合は新規作成し、存在する場合は更新する
- `note`フィールドは管理者が直接編集可能(FN038)
- `last_modified_by`と`last_modified_at`は、管理者による直接編集または修正申請の承認時に更新される
- 一般ユーザーによる打刻操作では`last_modified_by`と`last_modified_at`は更新されない
- `last_modified_by`は管理者権限を持つユーザー(role='admin')の user_id を保存

---

## 3. break_times(休憩時間)

| No. | テーブル名  | カラム名      | 型              | PRIMARY KEY | UNIQUE KEY | NOT NULL | FOREIGN KEY    | 備考             |
| --- | ----------- | ------------- | --------------- | ----------- | ---------- | -------- | -------------- | ---------------- |
| 3   | break_times | id            | BIGINT UNSIGNED | ●           |            | ●        |                | 主キー、自動採番 |
|     |             | attendance_id | BIGINT UNSIGNED |             |            | ●        | attendances.id | 勤怠 ID          |
|     |             | break_start   | TIME            |             |            |          |                | 休憩開始時刻     |
|     |             | break_end     | TIME            |             |            |          |                | 休憩終了時刻     |
|     |             | created_at    | TIMESTAMP       |             |            | ●        |                | 作成日時         |
|     |             | updated_at    | TIMESTAMP       |             |            | ●        |                | 更新日時         |

**説明**: 休憩時間の開始・終了時刻を管理するテーブル。1 勤怠記録につき複数回の休憩を記録可能(回数制限なし)。

**制約**:

- **外部キー制約**: attendance_id → attendances.id (ON DELETE CASCADE, ON UPDATE CASCADE)

**休憩回数の管理**:

- 休憩開始・休憩終了の打刻は何度でも可能(回数制限なし)
- 休憩の順序は`id`(作成順)または`created_at`で判定
- 各休憩は個別のレコードとして管理

**ステータス判定での利用**:

- `break_start`が NOT NULL かつ`break_end`が NULL → 該当休憩が「進行中」
- いずれかの休憩が進行中の場合、勤怠全体のステータスは「休憩中」

**対応機能**:

- FN021: 休憩打刻(休憩開始・休憩終了の打刻処理、何度でも可能)
- FN024: 月次情報表示(全休憩時間の合計を計算して表示)
- FN026: 詳細情報取得(全休憩時間の詳細を表示)
- FN027: 項目編集(すべての休憩を個別に編集可能 - 一般ユーザー)
- FN038: 項目編集(すべての休憩を個別に編集可能 - 管理者)

**備考**:

- 画面表示時は「個別の休憩時間」もしくは「全休憩時間の合計を計算したもの」で各画面の要件に応じて表示

---

## 4. stamp_correction_requests(打刻修正申請)

| No. | テーブル名                | カラム名            | 型              | PRIMARY KEY | UNIQUE KEY | NOT NULL | FOREIGN KEY    | 備考                     |
| --- | ------------------------- | ------------------- | --------------- | ----------- | ---------- | -------- | -------------- | ------------------------ |
| 4   | stamp_correction_requests | id                  | BIGINT UNSIGNED | ●           |            | ●        |                | 主キー、自動採番         |
|     |                           | attendance_id       | BIGINT UNSIGNED |             |            | ●        | attendances.id | 勤怠 ID                  |
|     |                           | user_id             | BIGINT UNSIGNED |             |            | ●        | users.id       | 申請者(ユーザー ID)      |
|     |                           | request_date        | DATE            |             |            | ●        |                | 申請日                   |
|     |                           | original_clock_in   | TIME            |             |            |          |                | 元の出勤時刻             |
|     |                           | original_clock_out  | TIME            |             |            |          |                | 元の退勤時刻             |
|     |                           | corrected_clock_in  | TIME            |             |            |          |                | 修正後出勤時刻           |
|     |                           | corrected_clock_out | TIME            |             |            |          |                | 修正後退勤時刻           |
|     |                           | note                | TEXT            |             |            | ●        |                | 備考(申請理由、必須)     |
|     |                           | approved_by         | BIGINT UNSIGNED |             |            |          | users.id       | 承認者(管理者の user_id) |
|     |                           | approved_at         | TIMESTAMP       |             |            |          |                | 承認日時                 |
|     |                           | created_at          | TIMESTAMP       |             |            | ●        |                | 作成日時                 |
|     |                           | updated_at          | TIMESTAMP       |             |            | ●        |                | 更新日時                 |

**説明**: 勤怠の出退勤時刻修正申請を管理するテーブル。一般ユーザーが申請し、管理者が承認する。申請時点での元データと修正後のデータを両方保持する。

**制約**:

- **外部キー制約**:
  - attendance_id → attendances.id (ON DELETE CASCADE, ON UPDATE CASCADE)
  - user_id → users.id (ON DELETE CASCADE, ON UPDATE CASCADE)
  - approved_by → users.id (ON DELETE SET NULL, ON UPDATE CASCADE)

**承認状態の判定**:

- `approved_at IS NULL`: 承認待ち
- `approved_at IS NOT NULL`: 承認済み

**データ保存の考え方**:

1. **申請作成時**:
   - 現在の`attendances`の出退勤時刻を`original_clock_in/out`にコピー
2. **ユーザー入力**:
   - 修正したい出退勤時刻を`corrected_clock_in/out`に保存
3. **承認時**:
   - `corrected_*`の値で`attendances`を更新
   - `approved_by`に承認した管理者の user_id、`approved_at`に承認日時を記録
4. **履歴保持**:
   - `original_*`は変更せず、修正前の状態を永続的に保持

**対応機能**:

- FN030: 修正申請(勤怠詳細画面から修正申請を作成)
- FN031: 承認待ち情報取得(自分の承認待ちの申請一覧を表示)
- FN032: 承認済み情報取得(自分の承認済みの申請一覧を表示)
- FN033: 申請詳細表示(申請の詳細情報を表示)
- FN047: 承認待ち情報取得(管理者 - 全ユーザーの承認待ち申請)
- FN048: 承認済み情報取得(管理者 - 全ユーザーの承認済み申請)
- FN049: 申請詳細表示(管理者 - 申請詳細画面へ遷移)
- FN050: 申請詳細取得(修正申請の詳細情報を取得)
- FN051: 承認処理(申請を承認し、元の勤怠レコードを更新)

**備考**:

- 申請は承認待ち → 承認済みの一方向のみ
- 管理者は申請内容を確認し、承認処理を行う(修正は不可)
- 却下機能は実装しないため、status カラムは不要
- note フィールドは必須で、空文字列は許可しない(バリデーション: required|string|min:1)
- 承認時に元の勤怠レコード(`attendances`)の出退勤時刻を更新
- `original_*`カラムは監査証跡として永続的に保持
- 休憩時間の修正申請は別テーブル(`break_correction_requests`)で管理

---

## 5. break_correction_requests(休憩時間修正申請)

| No. | テーブル名                | カラム名                    | 型              | PRIMARY KEY | UNIQUE KEY | NOT NULL | FOREIGN KEY                  | 備考                                   |
| --- | ------------------------- | --------------------------- | --------------- | ----------- | ---------- | -------- | ---------------------------- | -------------------------------------- |
| 5   | break_correction_requests | id                          | BIGINT UNSIGNED | ●           |            | ●        |                              | 主キー、自動採番                       |
|     |                           | stamp_correction_request_id | BIGINT UNSIGNED |             |            | ●        | stamp_correction_requests.id | 打刻修正申請 ID                        |
|     |                           | break_time_id               | BIGINT UNSIGNED |             |            |          | break_times.id               | 元の休憩時間 ID(新規追加の場合は NULL) |
|     |                           | original_break_start        | TIME            |             |            |          |                              | 元の休憩開始時刻                       |
|     |                           | original_break_end          | TIME            |             |            |          |                              | 元の休憩終了時刻                       |
|     |                           | corrected_break_start       | TIME            |             |            |          |                              | 修正後休憩開始時刻                     |
|     |                           | corrected_break_end         | TIME            |             |            |          |                              | 修正後休憩終了時刻                     |
|     |                           | created_at                  | TIMESTAMP       |             |            | ●        |                              | 作成日時                               |
|     |                           | updated_at                  | TIMESTAMP       |             |            | ●        |                              | 更新日時                               |

**説明**: 休憩時間の修正申請を管理するテーブル。1 つの打刻修正申請に対して複数の休憩時間の修正を紐付けることが可能。休憩の追加・修正に対応。削除する休憩は申請レコードを作成せず、承認時に物理削除。

**制約**:

- **外部キー制約**:
  - stamp_correction_request_id → stamp_correction_requests.id (ON DELETE CASCADE, ON UPDATE CASCADE)
  - break_time_id → break_times.id (ON DELETE SET NULL, ON UPDATE CASCADE)

**休憩時間修正のパターン**:

1. **既存休憩の修正**:

   - `break_time_id`: 既存の break_times.id
   - `original_break_start/end`: 元の休憩時刻
   - `corrected_break_start/end`: 修正後の休憩時刻

2. **新規休憩の追加**:

   - `break_time_id`: NULL
   - `original_break_start/end`: NULL
   - `corrected_break_start/end`: 追加する休憩時刻

3. **既存休憩の削除**:
   - 申請時: レコードを作成しない
   - 承認時: `break_times`から該当レコードを物理削除

**データ保存の考え方**:

1. **申請作成時**:

   - 既存の`break_times`で修正する休憩: 当テーブルにレコード作成
   - 新規追加する休憩: `break_time_id`を NULL にして当テーブルにレコード作成
   - 削除する休憩: レコードを作成しない

2. **承認時の処理**:
   - `break_time_id IS NOT NULL`: 既存の`break_times`レコードを更新
   - `break_time_id IS NULL`: 新しい`break_times`レコードを作成
   - 申請に含まれない既存の`break_times`: そのまま削除

**承認時の処理フロー**:

```
1. 申請の全レコードからbreak_time_idを収集
2. 元の勤怠の全break_timesを取得
3. 申請に含まれないbreak_timesを削除(削除対象)
4. 申請レコードを1件ずつ処理(修正または追加)
```

**対応機能**:

- FN030: 修正申請(複数の休憩時間をまとめて修正申請可能)
- FN031-FN033: 申請情報取得・詳細表示(一般ユーザー)
- FN047-FN051: 申請情報取得・詳細表示・承認処理(管理者)

**休憩時間を変更しない場合の扱い**:

- 出退勤時刻のみを修正し、休憩時間を一切変更しない場合、`break_correction_requests`にレコードを作成しない
- この場合、承認時に既存の休憩時間はそのまま保持される
- 休憩を変更する場合のみ、変更する休憩・追加する休憩のレコードを作成する

**備考**:

- 1 つの修正申請で複数の休憩時間を同時に申請可能
- 休憩の追加・修正・削除を柔軟に対応
- 削除する休憩は申請レコードに含めず、承認時に物理削除することでシンプルな設計を実現
- `original_*`カラムは監査証跡として永続的に保持

---

## テーブル間のリレーション

### ER 図

```
[users] 1 ──< N [attendances] 1 ──< N [break_times]
   │                │
   │                │ last_modified_by
   │                │ (role='admin'のみ)
   │                │
   │                └──< N [stamp_correction_requests] 1 ──< N [break_correction_requests]
   │                          │         │                               │
   │                          │         │                               │
   └──< N (user_id) ──────────┘         │                               │
                                         │                               │
                        approved_by ─────┘                               │
                        (role='admin')                                   │
                                                                          │
                             break_time_id ───────────────────────────────┘

外部キー関係:
• attendances.user_id → users.id
• attendances.last_modified_by → users.id (管理者による直接編集時、role='admin')
• break_times.attendance_id → attendances.id
• stamp_correction_requests.attendance_id → attendances.id
• stamp_correction_requests.user_id → users.id (申請者)
• stamp_correction_requests.approved_by → users.id (承認者、role='admin')
• break_correction_requests.stamp_correction_request_id → stamp_correction_requests.id
• break_correction_requests.break_time_id → break_times.id (既存休憩の場合のみ)
```

---

## データアクセスパターン

### 1. 認証・権限チェック

```php
// ミドルウェアでの管理者チェック
public function handle($request, Closure $next)
{
    if (Auth::check() && Auth::user()->role === 'admin') {
        return $next($request);
    }

    return redirect()->route('login')
        ->with('error', '管理者権限が必要です');
}

// 管理者判定メソッド(Userモデル)
public function isAdmin()
{
    return $this->role === 'admin';
}

// 一般ユーザー判定メソッド(Userモデル)
public function isGeneral()
{
    return $this->role === 'general';
}

// 全アクセス権限判定(Userモデル)
public function hasFullAccess(): bool
{
    return $this->role === 'admin' && $this->department_code === 1;
}

// 部門アクセス権限判定(Userモデル)
public function hasDepartmentAccess(): bool
{
    return $this->role === 'admin' && $this->department_code !== 1 && $this->department_code !== null;
}

// アクセス権限チェック(Userモデル)
public function canViewAttendance(int $targetUserId): bool
{
    // 自分の勤怠は常に参照可能
    if ($this->id === $targetUserId) {
        return true;
    }

    $targetUser = self::find($targetUserId);
    if (!$targetUser) {
        return false;
    }

    // 全アクセス権限（admin + department_code=1）を持つ場合は全員の勤怠を見られる
    if ($this->hasFullAccess()) {
        return true;
    }

    // 部門アクセス権限（admin + department_code!=1）を持つ場合は同じ部門のメンバーの勤怠を見られる
    if ($this->hasDepartmentAccess() && $this->department_code === $targetUser->department_code) {
        return true;
    }

    // 一般ユーザー（general）は自分の勤怠のみ
    return false;
}

// 自身の承認可否判定(Userモデル)
public function canApproveOwnRequest(): bool
{
    // 部門アクセス権限（admin + department_code!=1）を持つ場合は自身の承認ができない
    if ($this->hasDepartmentAccess()) {
        return false;
    }

    // 全アクセス権限（admin + department_code=1）を持つ場合は自身の承認ができる
    return $this->hasFullAccess();
}
```

### 2. 勤怠記録の取得

```php
// Attendanceモデルのリレーション定義
public function user()
{
    return $this->belongsTo(User::class);
}

public function breakTimes()
{
    return $this->hasMany(BreakTime::class)->orderBy('id');
}

public function lastModifiedBy()
{
    return $this->belongsTo(User::class, 'last_modified_by');
}

public function stampCorrectionRequests()
{
    return $this->hasMany(StampCorrectionRequest::class);
}

// 勤怠情報の取得(休憩時間を含む) - 一般ユーザー
$attendances = Attendance::with(['user', 'breakTimes', 'lastModifiedBy'])
    ->where('user_id', Auth::id())
    ->where('date', $date)
    ->get();

// 勤怠情報の取得(休憩時間を含む) - 管理者（アクセス権限に基づくフィルタリング）
$currentUser = Auth::user();

$query = Attendance::where('date', $date)
    ->whereNotNull('clock_in')
    ->with(['user', 'breakTimes']);

// 部門アクセス権限の場合は同じ部門のメンバーのみ
if ($currentUser->hasDepartmentAccess()) {
    $sameDepartmentUserIds = User::where('department_code', $currentUser->department_code)
        ->pluck('id');

    $query->whereIn('user_id', $sameDepartmentUserIds);
}
// 全アクセス権限の場合はフィルタリングなし（全員の勤怠を表示）

$attendances = $query->orderBy('user_id', 'asc')->get();
```

### 3. 修正申請の作成(出退勤+休憩時間)

#### 3-1. 出退勤のみ修正する場合(休憩は変更しない)

```php
DB::transaction(function () use ($attendance, $requestData) {
    // 出退勤の修正申請のみ作成
    $stampRequest = StampCorrectionRequest::create([
        'attendance_id' => $attendance->id,
        'user_id' => Auth::id(),
        'request_date' => now()->toDateString(),
        'original_clock_in' => $attendance->clock_in,
        'original_clock_out' => $attendance->clock_out,
        'corrected_clock_in' => $requestData['clock_in'],
        'corrected_clock_out' => $requestData['clock_out'],
        'note' => $requestData['note'],
    ]);

    // 休憩時間の修正申請は作成しない
    // 承認時、既存の休憩はそのまま保持される
});
```

#### 3-2. 出退勤と休憩の両方を修正する場合

```php
DB::transaction(function () use ($attendance, $requestData) {
    // 1. 出退勤の修正申請を作成
    $stampRequest = StampCorrectionRequest::create([
        'attendance_id' => $attendance->id,
        'user_id' => Auth::id(),
        'request_date' => now()->toDateString(),
        'original_clock_in' => $attendance->clock_in,
        'original_clock_out' => $attendance->clock_out,
        'corrected_clock_in' => $requestData['clock_in'],
        'corrected_clock_out' => $requestData['clock_out'],
        'note' => $requestData['note'],
    ]);

    // 2. 休憩時間の修正申請を作成
    // 既存の休憩を修正
    foreach ($requestData['breaks']['modified'] as $breakData) {
        BreakCorrectionRequest::create([
            'stamp_correction_request_id' => $stampRequest->id,
            'break_time_id' => $breakData['id'],
            'original_break_start' => $breakData['original_start'],
            'original_break_end' => $breakData['original_end'],
            'corrected_break_start' => $breakData['corrected_start'],
            'corrected_break_end' => $breakData['corrected_end'],
        ]);
    }

    // 新規の休憩を追加
    foreach ($requestData['breaks']['added'] as $breakData) {
        BreakCorrectionRequest::create([
            'stamp_correction_request_id' => $stampRequest->id,
            'break_time_id' => null,
            'original_break_start' => null,
            'original_break_end' => null,
            'corrected_break_start' => $breakData['start'],
            'corrected_break_end' => $breakData['end'],
        ]);
    }

    // 削除する休憩: レコードを作成しない
    // 承認時に、申請に含まれない既存の休憩を削除する
});
```

### 4. 修正申請の承認処理

```php
DB::transaction(function () use ($stampRequest) {
    $attendance = $stampRequest->attendance;

    // 1. 出退勤時刻の更新
    $attendance->update([
        'clock_in' => $stampRequest->corrected_clock_in,
        'clock_out' => $stampRequest->corrected_clock_out,
        'last_modified_by' => Auth::id(), // 承認した管理者のID
        'last_modified_at' => now(),
    ]);

    // 2. 休憩時間の更新
    $breakRequests = $stampRequest->breakCorrectionRequests;

    // 休憩の修正申請がある場合のみ処理
    if ($breakRequests->isNotEmpty()) {
        // 申請に含まれるbreak_time_idを収集
        $requestedBreakTimeIds = $breakRequests->pluck('break_time_id')->filter()->toArray();

        // 申請に含まれない既存の休憩を削除（削除対象）
        if (!empty($requestedBreakTimeIds)) {
            // 一部の休憩を残す場合
            $attendance->breakTimes()
                ->whereNotIn('id', $requestedBreakTimeIds)
                ->delete();
        } else {
            // すべて新規追加の場合、既存の休憩を全削除
            $attendance->breakTimes()->delete();
        }

        // 申請レコードを処理（修正または追加）
        foreach ($breakRequests as $breakRequest) {
            if ($breakRequest->break_time_id) {
                // 既存休憩の修正
                BreakTime::find($breakRequest->break_time_id)->update([
                    'break_start' => $breakRequest->corrected_break_start,
                    'break_end' => $breakRequest->corrected_break_end,
                ]);
            } else {
                // 新規休憩の追加
                BreakTime::create([
                    'attendance_id' => $attendance->id,
                    'break_start' => $breakRequest->corrected_break_start,
                    'break_end' => $breakRequest->corrected_break_end,
                ]);
            }
        }
    }
    // 休憩の修正申請がない場合は既存の休憩をそのまま保持

    // 3. 申請を承認済みに更新
    $stampRequest->update([
        'approved_by' => Auth::id(),
        'approved_at' => now(),
    ]);
});
```

### 5. 休憩時間の合計計算

```php
// Attendanceモデル

// 休憩時間の合計を計算(分単位)
public function getTotalBreakMinutes()
{
    $totalMinutes = 0;

    foreach ($this->breakTimes as $breakTime) {
        if ($breakTime->break_start && $breakTime->break_end) {
            $start = Carbon::parse($breakTime->break_start);
            $end = Carbon::parse($breakTime->break_end);
            $totalMinutes += $start->diffInMinutes($end);
        }
    }

    return $totalMinutes;
}

// 休憩時間の合計をHH:MM形式で取得
public function getTotalBreakTime()
{
    $totalMinutes = $this->getTotalBreakMinutes();
    $hours = floor($totalMinutes / 60);
    $minutes = $totalMinutes % 60;

    return sprintf('%02d:%02d', $hours, $minutes);
}
```

### 6. 実働時間の計算

```php
// 実働時間を計算(分単位)
public function getWorkMinutes()
{
    if (!$this->clock_in || !$this->clock_out) {
        return 0;
    }

    $clockIn = Carbon::parse($this->clock_in);
    $clockOut = Carbon::parse($this->clock_out);

    $totalMinutes = $clockIn->diffInMinutes($clockOut);
    $breakMinutes = $this->getTotalBreakMinutes();

    return max(0, $totalMinutes - $breakMinutes);
}

// 実働時間をHH:MM形式で取得
public function getWorkTime()
{
    $workMinutes = $this->getWorkMinutes();
    $hours = floor($workMinutes / 60);
    $minutes = $workMinutes % 60;

    return sprintf('%02d:%02d', $hours, $minutes);
}
```

### 7. 管理者による直接編集

```php
// 出退勤時刻の直接編集（アクセス権限チェック付き）
public function updateAttendance(AdminCorrectionRequest $request, $id)
{
    $currentUser = Auth::user();
    $attendance = Attendance::findOrFail($id);

    // アクセス権限チェック
    if (!$currentUser->canViewAttendance($attendance->user_id)) {
        abort(403, 'この勤怠情報を修正する権限がありません');
    }

    // 承認待ちの修正申請がある場合は修正不可
    $pendingRequest = StampCorrectionRequest::where('attendance_id', $attendance->id)
        ->whereNull('approved_at')
        ->first();

    if ($pendingRequest) {
        return back()->withErrors(['note' => '承認待ちのため修正はできません。']);
    }

    DB::beginTransaction();

    try {
        // 出退勤時刻の更新
        $attendance->update([
            'clock_in' => $request->corrected_clock_in,
            'clock_out' => $request->corrected_clock_out,
            'note' => $request->note,
            'last_modified_by' => $currentUser->id, // 管理者のID
            'last_modified_at' => now(),
        ]);

        // 休憩時間の更新処理...

        DB::commit();

        return redirect()->back()
            ->with('success', '勤怠情報を更新しました');
    } catch (\Exception $e) {
        DB::rollBack();
        return back()->withErrors(['note' => '勤怠修正に失敗しました。']);
    }
}

// 休憩時間の直接編集
public function updateBreakTimes(Request $request, $attendanceId)
{
    DB::transaction(function () use ($request, $attendanceId) {
        $attendance = Attendance::findOrFail($attendanceId);

        // 既存の休憩時間を削除
        $attendance->breakTimes()->delete();

        // 新しい休憩時間を作成
        foreach ($request->breaks as $break) {
            if ($break['break_start'] && $break['break_end']) {
                BreakTime::create([
                    'attendance_id' => $attendanceId,
                    'break_start' => $break['break_start'],
                    'break_end' => $break['break_end'],
                ]);
            }
        }

        // 最終更新情報を記録
        $attendance->update([
            'last_modified_by' => Auth::id(),
            'last_modified_at' => now(),
        ]);
    });

    return redirect()->back()
        ->with('success', '休憩時間を更新しました');
}
```

---

## モデル定義例

### User モデル

```php
class User extends Authenticatable
{
    protected $fillable = [
        'name',
        'email',
        'password',
        'role',
        'department_code',
        'email_verified_at',
        'verification_code',
        'verification_code_expires_at',
    ];

    protected $hidden = [
        'password',
        'remember_token',
        'verification_code',
    ];

    protected $casts = [
        'email_verified_at' => 'datetime',
        'verification_code_expires_at' => 'datetime',
    ];

    // 管理者判定
    public function isAdmin()
    {
        return $this->role === 'admin';
    }

    // 一般ユーザー判定
    public function isGeneral()
    {
        return $this->role === 'general';
    }

    /**
     * 全ユーザーの勤怠を参照できる権限を持つか判定（role='admin' && department_code=1）
     */
    public function hasFullAccess(): bool
    {
        return $this->role === 'admin' && $this->department_code === 1;
    }

    /**
     * 部門単位で勤怠を参照できる権限を持つか判定（role='admin' && department_code!=1）
     */
    public function hasDepartmentAccess(): bool
    {
        return $this->role === 'admin' && $this->department_code !== 1 && $this->department_code !== null;
    }

    /**
     * 指定されたユーザーの勤怠を参照できるかを判定
     */
    public function canViewAttendance(int $targetUserId): bool
    {
        // 自分の勤怠は常に参照可能
        if ($this->id === $targetUserId) {
            return true;
        }

        $targetUser = self::find($targetUserId);
        if (!$targetUser) {
            return false;
        }

        // 全アクセス権限（admin + department_code=1）を持つ場合は全員の勤怠を見られる
        if ($this->hasFullAccess()) {
            return true;
        }

        // 部門アクセス権限（admin + department_code!=1）を持つ場合は同じ部門のメンバーの勤怠を見られる
        if ($this->hasDepartmentAccess() && $this->department_code === $targetUser->department_code) {
            return true;
        }

        // 一般ユーザー（general）は自分の勤怠のみ
        return false;
    }

    /**
     * 自身の承認ができるかを判定
     * 部門アクセス権限を持つ管理者は自身の承認ができない
     */
    public function canApproveOwnRequest(): bool
    {
        // 部門アクセス権限（admin + department_code!=1）を持つ場合は自身の承認ができない
        if ($this->hasDepartmentAccess()) {
            return false;
        }

        // 全アクセス権限（admin + department_code=1）を持つ場合は自身の承認ができる
        return $this->hasFullAccess();
    }

    // リレーション
    public function attendances()
    {
        return $this->hasMany(Attendance::class);
    }

    public function stampCorrectionRequests()
    {
        return $this->hasMany(StampCorrectionRequest::class);
    }

    public function modifiedAttendances()
    {
        return $this->hasMany(Attendance::class, 'last_modified_by');
    }

    public function approvedRequests()
    {
        return $this->hasMany(StampCorrectionRequest::class, 'approved_by');
    }
}
```

### Attendance モデル

```php
class Attendance extends Model
{
    protected $fillable = [
        'user_id',
        'date',
        'clock_in',
        'clock_out',
        'note',
        'last_modified_by',
        'last_modified_at',
    ];

    protected $casts = [
        'date' => 'date',
        'clock_in' => 'string',
        'clock_out' => 'string',
        'last_modified_at' => 'datetime',
    ];

    // リレーション
    public function user()
    {
        return $this->belongsTo(User::class);
    }

    public function breakTimes()
    {
        return $this->hasMany(BreakTime::class)->orderBy('id');
    }

    public function lastModifiedBy()
    {
        return $this->belongsTo(User::class, 'last_modified_by');
    }

    public function stampCorrectionRequests()
    {
        return $this->hasMany(StampCorrectionRequest::class);
    }
}
```

### BreakTime モデル

```php
class BreakTime extends Model
{
    protected $fillable = [
        'attendance_id',
        'break_start',
        'break_end',
    ];

    protected $casts = [
        'break_start' => 'string',
        'break_end' => 'string',
    ];

    // リレーション
    public function attendance()
    {
        return $this->belongsTo(Attendance::class);
    }

    public function breakCorrectionRequests()
    {
        return $this->hasMany(BreakCorrectionRequest::class);
    }
}
```

### StampCorrectionRequest モデル

```php
class StampCorrectionRequest extends Model
{
    protected $fillable = [
        'attendance_id',
        'user_id',
        'request_date',
        'original_clock_in',
        'original_clock_out',
        'corrected_clock_in',
        'corrected_clock_out',
        'note',
        'approved_by',
        'approved_at',
    ];

    protected $casts = [
        'request_date' => 'date',
        'original_clock_in' => 'string',
        'original_clock_out' => 'string',
        'corrected_clock_in' => 'string',
        'corrected_clock_out' => 'string',
        'approved_at' => 'datetime',
    ];

    // リレーション
    public function attendance()
    {
        return $this->belongsTo(Attendance::class);
    }

    public function user()
    {
        return $this->belongsTo(User::class);
    }

    public function approvedBy()
    {
        return $this->belongsTo(User::class, 'approved_by');
    }

    public function breakCorrectionRequests()
    {
        return $this->hasMany(BreakCorrectionRequest::class);
    }

    // 承認状態の判定
    public function isApproved()
    {
        return !is_null($this->approved_at);
    }

    public function isPending()
    {
        return is_null($this->approved_at);
    }
}
```

### BreakCorrectionRequest モデル

```php
class BreakCorrectionRequest extends Model
{
    protected $fillable = [
        'stamp_correction_request_id',
        'break_time_id',
        'original_break_start',
        'original_break_end',
        'corrected_break_start',
        'corrected_break_end',
    ];

    protected $casts = [
        'original_break_start' => 'string',
        'original_break_end' => 'string',
        'corrected_break_start' => 'string',
        'corrected_break_end' => 'string',
    ];

    // リレーション
    public function stampCorrectionRequest()
    {
        return $this->belongsTo(StampCorrectionRequest::class);
    }

    public function breakTime()
    {
        return $this->belongsTo(BreakTime::class);
    }

    // 操作タイプの判定
    public function isModification()
    {
        return !is_null($this->break_time_id);
    }

    public function isAddition()
    {
        return is_null($this->break_time_id);
    }
}
```

---

## マイグレーションファイル例

### users テーブル

```php
// 1. 基本テーブル作成
Schema::create('users', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->string('email')->unique();
    $table->timestamp('email_verified_at')->nullable();
    $table->string('password');
    $table->rememberToken();
    $table->timestamps();
});

// 2. roleと認証コードカラムを追加
Schema::table('users', function (Blueprint $table) {
    $table->enum('role', ['general', 'admin'])->default('general')->after('password');
    $table->string('verification_code', 6)->nullable()->after('role');
    $table->timestamp('verification_code_expires_at')->nullable()->after('verification_code');
});

// 3. department_codeカラムを追加
Schema::table('users', function (Blueprint $table) {
    $table->integer('department_code')->nullable()->after('role');
});
```

### attendances テーブル

```php
Schema::create('attendances', function (Blueprint $table) {
    $table->id();
    $table->foreignId('user_id')->constrained()->cascadeOnUpdate()->cascadeOnDelete();
    $table->date('date');
    $table->time('clock_in')->nullable();
    $table->time('clock_out')->nullable();
    $table->text('note')->nullable();
    $table->foreignId('last_modified_by')->nullable()->constrained('users')->nullOnDelete()->cascadeOnUpdate();
    $table->timestamp('last_modified_at')->nullable();
    $table->timestamps();

    $table->unique(['user_id', 'date']);
});
```

### break_times テーブル

```php
Schema::create('break_times', function (Blueprint $table) {
    $table->id();
    $table->foreignId('attendance_id')->constrained()->cascadeOnUpdate()->cascadeOnDelete();
    $table->time('break_start')->nullable();
    $table->time('break_end')->nullable();
    $table->timestamps();
});
```

### stamp_correction_requests テーブル

```php
Schema::create('stamp_correction_requests', function (Blueprint $table) {
    $table->id();
    $table->foreignId('attendance_id')->constrained()->cascadeOnUpdate()->cascadeOnDelete();
    $table->foreignId('user_id')->constrained()->cascadeOnUpdate()->cascadeOnDelete();
    $table->date('request_date');
    $table->time('original_clock_in')->nullable();
    $table->time('original_clock_out')->nullable();
    $table->time('corrected_clock_in')->nullable();
    $table->time('corrected_clock_out')->nullable();
    $table->text('note');
    $table->foreignId('approved_by')->nullable()->constrained('users')->nullOnDelete()->cascadeOnUpdate();
    $table->timestamp('approved_at')->nullable();
    $table->timestamps();
});
```

### break_correction_requests テーブル

```php
Schema::create('break_correction_requests', function (Blueprint $table) {
    $table->id();
    $table->foreignId('stamp_correction_request_id')->constrained()->cascadeOnUpdate()->cascadeOnDelete();
    $table->foreignId('break_time_id')->nullable()->constrained('break_times')->nullOnDelete()->cascadeOnUpdate();
    $table->time('original_break_start')->nullable();
    $table->time('original_break_end')->nullable();
    $table->time('corrected_break_start')->nullable();
    $table->time('corrected_break_end')->nullable();
    $table->timestamps();
});
```

---

## まとめ

### テーブル構成

- **users**: 一般ユーザーと管理者の基本情報(role で区別、department_code でアクセス制御)
- **attendances**: 日次勤怠記録(出退勤時刻、備考)
- **break_times**: 休憩時間(複数回可能)
- **stamp_correction_requests**: 出退勤時刻の修正申請
- **break_correction_requests**: 休憩時間の修正申請(複数まとめて可能)

### アクセス制御の概要

- **全アクセス権限** (`role='admin'` && `department_code=1`): 全ユーザーの勤怠を参照・修正・承認可能
- **部門アクセス権限** (`role='admin'` && `department_code!=1`): 同じ部門コードのメンバーの勤怠を参照・修正可能（自身の承認は不可）
- **一般ユーザー** (`role='general'`): 自分の勤怠のみ参照可能

### 機能要件との対応

本テーブル設計は、機能要件一覧(FN001~FN051)の全ての機能に対応しています:

- **US001 (会員登録)**: FN001~FN005 → users(role='general')
- **US002 (ログイン)**: FN006~FN013 → users(role='general')
- **US004 (管理者ログイン)**: FN014~FN017 → users(role='admin')
- **US006 (打刻)**: FN018~FN022 → attendances, break_times
- **US007 (勤怠一覧)**: FN023~FN025 → attendances, break_times
- **US008 (勤怠詳細・修正申請)**: FN026~FN030 → attendances, break_times, stamp_correction_requests, break_correction_requests
- **US009 (申請一覧)**: FN031~FN033 → stamp_correction_requests, break_correction_requests
- **US010 (管理者: 日次勤怠)**: FN034~FN036 → attendances, break_times
- **US011 (管理者: 勤怠の確認・修正)**: FN037~FN040 → attendances, break_times
- **US012 (管理者: スタッフ一覧)**: FN041 → users
- **US013 (管理者: 月次勤怠)**: FN042~FN046 → attendances, break_times
- **US014 (管理者: 申請一覧)**: FN047~FN049 → stamp_correction_requests, break_correction_requests
- **US015 (管理者: 承認)**: FN050~FN051 → stamp_correction_requests, break_correction_requests, attendances, break_times
