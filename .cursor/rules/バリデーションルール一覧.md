# バリデーションルール一覧表

## 概要
本ドキュメントは、勤怠管理システムにおけるバリデーションルールとエラーメッセージ表示の仕様を定義します。

---

## 1. 会員登録 (RegisterRequest.php)

### 対応機能: FN002, FN003

| No. | フォーム項目 | バリデーションルール | エラーメッセージ |
|-----|------------|---------------------|----------------|
| 1-1 | 氏名 (name) | - 入力必須<br>- 文字列型<br>- 最大255文字 | - 名前を入力してください<br>- 名前は文字列で入力してください<br>- 名前は255文字以内で入力してください |
| 1-2 | メールアドレス (email) | - 入力必須<br>- 文字列型<br>- メール形式<br>- 最大255文字<br>- usersテーブルでユニーク | - メールアドレスを入力してください<br>- メールアドレスは文字列で入力してください<br>- 有効なメールアドレスを入力してください<br>- メールアドレスは255文字以内で入力してください<br>- このメールアドレスは既に使用されています |
| 1-3 | パスワード (password) | - 入力必須<br>- 文字列型<br>- 最小8文字以上<br>- 確認用パスワードと一致 | - パスワードを入力してください<br>- パスワードは文字列で入力してください<br>- パスワードは8文字以上で入力してください<br>- パスワードと確認用パスワードが一致しません |
| 1-4 | 確認用パスワード (password_confirmation) | - 入力必須<br>- パスワードと一致 | - 確認用パスワードを入力してください<br>- パスワードと確認用パスワードが一致しません |

### 実装例
```php
// app/Http/Requests/RegisterRequest.php
public function rules()
{
    return [
        'name' => ['required', 'string', 'max:255'],
        'email' => ['required', 'string', 'email', 'max:255', 'unique:users'],
        'password' => ['required', 'string', 'min:8', 'confirmed'],
    ];
}

public function messages()
{
    return [
        'name.required' => '名前を入力してください',
        'name.string' => '名前は文字列で入力してください',
        'name.max' => '名前は255文字以内で入力してください',
        'email.required' => 'メールアドレスを入力してください',
        'email.string' => 'メールアドレスは文字列で入力してください',
        'email.email' => '有効なメールアドレスを入力してください',
        'email.max' => 'メールアドレスは255文字以内で入力してください',
        'email.unique' => 'このメールアドレスは既に使用されています',
        'password.required' => 'パスワードを入力してください',
        'password.string' => 'パスワードは文字列で入力してください',
        'password.min' => 'パスワードは8文字以上で入力してください',
        'password.confirmed' => 'パスワードと確認用パスワードが一致しません',
    ];
}
```

---

## 2. ログイン (LoginRequest.php)

### 対応機能: FN008, FN009

| No. | フォーム項目 | バリデーションルール | エラーメッセージ |
|-----|------------|---------------------|----------------|
| 2-1 | メールアドレス (email) | - 入力必須<br>- 文字列型<br>- メール形式<br>- 最大255文字 | - メールアドレスを入力してください<br>- メールアドレスは文字列で入力してください<br>- 有効なメールアドレスを入力してください<br>- メールアドレスは255文字以内で入力してください |
| 2-2 | パスワード (password) | - 入力必須<br>- 文字列型 | - パスワードを入力してください<br>- パスワードは文字列で入力してください |

### ログイン認証エラー (FN009)
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| メールアドレスまたはパスワードが間違っている | ログイン情報が登録されていません |

### 実装例
```php
// app/Http/Requests/LoginRequest.php
public function rules()
{
    return [
        'email' => ['required', 'string', 'email', 'max:255'],
        'password' => ['required', 'string'],
    ];
}

public function messages()
{
    return [
        'email.required' => 'メールアドレスを入力してください',
        'email.string' => 'メールアドレスは文字列で入力してください',
        'email.email' => '有効なメールアドレスを入力してください',
        'email.max' => 'メールアドレスは255文字以内で入力してください',
        'password.required' => 'パスワードを入力してください',
        'password.string' => 'パスワードは文字列で入力してください',
    ];
}
```

---

## 3. 管理者ログイン (AdminLoginRequest.php)

### 対応機能: FN015, FN016

| No. | フォーム項目 | バリデーションルール | エラーメッセージ |
|-----|------------|---------------------|----------------|
| 3-1 | メールアドレス (email) | - 入力必須<br>- 文字列型<br>- メール形式<br>- 最大255文字 | - メールアドレスを入力してください<br>- メールアドレスは文字列で入力してください<br>- 有効なメールアドレスを入力してください<br>- メールアドレスは255文字以内で入力してください |
| 3-2 | パスワード (password) | - 入力必須<br>- 文字列型 | - パスワードを入力してください<br>- パスワードは文字列で入力してください |

### 管理者ログイン認証エラー (FN016)
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| メールアドレスまたはパスワードが間違っている | ログイン情報が登録されていません |

### 実装例
```php
// app/Http/Requests/AdminLoginRequest.php
public function rules()
{
    return [
        'email' => ['required', 'string', 'email', 'max:255'],
        'password' => ['required', 'string'],
    ];
}

public function messages()
{
    return [
        'email.required' => 'メールアドレスを入力してください',
        'email.string' => 'メールアドレスは文字列で入力してください',
        'email.email' => '有効なメールアドレスを入力してください',
        'email.max' => 'メールアドレスは255文字以内で入力してください',
        'password.required' => 'パスワードを入力してください',
        'password.string' => 'パスワードは文字列で入力してください',
    ];
}
```

---

## 4. 打刻処理 (StampRequest.php)

### 対応機能: FN028, FN029

| No. | フォーム項目 | バリデーションルール | エラーメッセージ |
|-----|------------|---------------------|----------------|
| 4-1 | 打刻タイプ (stamp_type) | - 入力必須<br>- 文字列型<br>- 以下のいずれか: 'clock_in', 'clock_out', 'break_start', 'break_end' | - 打刻タイプを入力してください<br>- 打刻タイプは文字列で入力してください<br>- 無効な打刻タイプです |
| 4-2 | 休憩番号 (break_number) | - 打刻タイプが'break_start'または'break_end'の場合に必須<br>- 整数型<br>- 1または2 | - 休憩番号を入力してください<br>- 休憩番号は整数で入力してください<br>- 休憩番号は1または2で入力してください |

### 打刻処理時のステータスエラー (FN029)

#### 出勤前の状態でのエラー
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| 「出勤」以外の打刻を試みた場合 | まだ出勤していません |

#### 出勤時刻が記録されている状態でのエラー
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| 「出勤」の打刻を試みた場合 | 既に出勤しています |

#### 休憩開始時刻が出勤時刻より前の場合
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| 休憩開始時刻 < 出勤時刻 | 出勤時刻より前に休憩を開始できません |

#### 休憩開始時刻が退勤時刻より後の場合
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| 休憩開始時刻 > 退勤時刻 | 退勤時刻より後に休憩を開始できません |

#### 休憩終了時刻が休憩開始時刻より前の場合
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| 休憩終了時刻 < 休憩開始時刻 | 休憩開始時刻より前に休憩を終了できません |

#### 休憩終了時刻が退勤時刻より後の場合
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| 休憩終了時刻 > 退勤時刻 | 退勤時刻より後に休憩を終了できません |

#### 無効な遷移を試みた場合
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| - 休憩中に「休憩開始」を試みた<br>- 休憩中でないのに「休憩終了」を試みた<br>- その他の無効な遷移 | 無効な打刻です |

### 実装例
```php
// app/Http/Requests/StampRequest.php
public function rules()
{
    return [
        'stamp_type' => ['required', 'string', 'in:clock_in,clock_out,break_start,break_end'],
        'break_number' => ['required_if:stamp_type,break_start,break_end', 'integer', 'in:1,2'],
    ];
}

public function messages()
{
    return [
        'stamp_type.required' => '打刻タイプを入力してください',
        'stamp_type.string' => '打刻タイプは文字列で入力してください',
        'stamp_type.in' => '無効な打刻タイプです',
        'break_number.required_if' => '休憩番号を入力してください',
        'break_number.integer' => '休憩番号は整数で入力してください',
        'break_number.in' => '休憩番号は1または2で入力してください',
    ];
}
```

---

## 5. 修正申請 (CorrectionRequest.php)

### 対応機能: FN028, FN030

| No. | フォーム項目 | バリデーションルール | エラーメッセージ |
|-----|------------|---------------------|----------------|
| 5-1 | 修正出勤時間 (corrected_clock_in) | - 任意<br>- 日時形式 (Y-m-d H:i:s または Y-m-d\TH:i)<br>- 修正退勤時間より前であること | - 修正出勤時間は日時形式で入力してください<br>- 修正出勤時間は修正退勤時間より前に設定してください |
| 5-2 | 修正退勤時間 (corrected_clock_out) | - 任意<br>- 日時形式 (Y-m-d H:i:s または Y-m-d\TH:i)<br>- 修正出勤時間より後であること | - 修正退勤時間は日時形式で入力してください<br>- 修正退勤時間は修正出勤時間より後に設定してください |
| 5-3 | 修正休憩時間 (corrected_break_time) | - 任意<br>- 時間形式 (H:i:s または H:i)<br>- 0時間以上<br>- 実働時間を超えないこと | - 修正休憩時間は時間形式で入力してください<br>- 修正休憩時間は0時間以上で入力してください<br>- 修正休憩時間は実働時間を超えることはできません |
| 5-4 | 備考(申請理由) (note) | - 入力必須<br>- 文字列型<br>- 最大255文字 | - 備考を入力してください<br>- 備考は文字列で入力してください<br>- 備考は255文字以内で入力してください |

### 修正申請時のバリデーションエラー (FN028)

#### 出勤時間が退勤時間より後になっている場合
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| 修正出勤時間 ≥ 修正退勤時間 | 修正出勤時間は修正退勤時間より前に設定してください |

#### 休憩時間が実働時間を超える場合
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| 修正休憩時間 > (修正退勤時間 - 修正出勤時間) | 修正休憩時間は実働時間を超えることはできません |

#### 備考が未入力の場合
| エラー条件 | エラーメッセージ |
|-----------|----------------|
| note が空 | 備考を入力してください |

### 実装例
```php
// app/Http/Requests/CorrectionRequest.php
public function rules()
{
    return [
        'corrected_clock_in' => ['nullable', 'date_format:Y-m-d\TH:i', 'before:corrected_clock_out'],
        'corrected_clock_out' => ['nullable', 'date_format:Y-m-d\TH:i', 'after:corrected_clock_in'],
        'corrected_break_time' => ['nullable', 'date_format:H:i', 'regex:/^(?:[01]\d|2[0-3]):[0-5]\d$/'],
        'note' => ['required', 'string', 'max:255'],
    ];
}

public function messages()
{
    return [
        'corrected_clock_in.date_format' => '修正出勤時間は日時形式で入力してください',
        'corrected_clock_in.before' => '修正出勤時間は修正退勤時間より前に設定してください',
        'corrected_clock_out.date_format' => '修正退勤時間は日時形式で入力してください',
        'corrected_clock_out.after' => '修正退勤時間は修正出勤時間より後に設定してください',
        'corrected_break_time.date_format' => '修正休憩時間は時間形式で入力してください',
        'corrected_break_time.regex' => '修正休憩時間は有効な時間形式で入力してください',
        'note.required' => '備考を入力してください',
        'note.string' => '備考は文字列で入力してください',
        'note.max' => '備考は255文字以内で入力してください',
    ];
}

public function withValidator($validator)
{
    $validator->after(function ($validator) {
        // 実働時間を超える休憩時間のチェック
        if ($this->corrected_clock_in && $this->corrected_clock_out && $this->corrected_break_time) {
            $clockIn = \Carbon\Carbon::parse($this->corrected_clock_in);
            $clockOut = \Carbon\Carbon::parse($this->corrected_clock_out);
            $totalMinutes = $clockIn->diffInMinutes($clockOut);
            
            list($hours, $minutes) = explode(':', $this->corrected_break_time);
            $breakMinutes = ($hours * 60) + $minutes;
            
            if ($breakMinutes > $totalMinutes) {
                $validator->errors()->add('corrected_break_time', '修正休憩時間は実働時間を超えることはできません');
            }
        }
    });
}
```

---

## 6. 承認処理 (ApprovalRequest.php)

### 対応機能: FN040

| No. | フォーム項目 | バリデーションルール | エラーメッセージ |
|-----|------------|---------------------|----------------|
| 6-1 | 修正出勤時間 (corrected_clock_in) | - 任意<br>- 日時形式 (Y-m-d H:i:s または Y-m-d\TH:i)<br>- 修正退勤時間より前であること | - 修正出勤時間は日時形式で入力してください<br>- 修正出勤時間は修正退勤時間より前に設定してください |
| 6-2 | 修正退勤時間 (corrected_clock_out) | - 任意<br>- 日時形式 (Y-m-d H:i:s または Y-m-d\TH:i)<br>- 修正出勤時間より後であること | - 修正退勤時間は日時形式で入力してください<br>- 修正退勤時間は修正出勤時間より後に設定してください |
| 6-3 | 修正休憩時間 (corrected_break_time) | - 任意<br>- 時間形式 (H:i:s または H:i)<br>- 0時間以上<br>- 実働時間を超えないこと | - 修正休憩時間は時間形式で入力してください<br>- 修正休憩時間は0時間以上で入力してください<br>- 修正休憩時間は実働時間を超えることはできません |
| 6-4 | 備考(申請理由) (note) | - 任意<br>- 文字列型<br>- 最大255文字 | - 備考は文字列で入力してください<br>- 備考は255文字以内で入力してください |

### 実装例
```php
// app/Http/Requests/ApprovalRequest.php
public function rules()
{
    return [
        'corrected_clock_in' => ['nullable', 'date_format:Y-m-d\TH:i', 'before:corrected_clock_out'],
        'corrected_clock_out' => ['nullable', 'date_format:Y-m-d\TH:i', 'after:corrected_clock_in'],
        'corrected_break_time' => ['nullable', 'date_format:H:i', 'regex:/^(?:[01]\d|2[0-3]):[0-5]\d$/'],
        'note' => ['nullable', 'string', 'max:255'],
    ];
}

public function messages()
{
    return [
        'corrected_clock_in.date_format' => '修正出勤時間は日時形式で入力してください',
        'corrected_clock_in.before' => '修正出勤時間は修正退勤時間より前に設定してください',
        'corrected_clock_out.date_format' => '修正退勤時間は日時形式で入力してください',
        'corrected_clock_out.after' => '修正退勤時間は修正出勤時間より後に設定してください',
        'corrected_break_time.date_format' => '修正休憩時間は時間形式で入力してください',
        'corrected_break_time.regex' => '修正休憩時間は有効な時間形式で入力してください',
        'note.string' => '備考は文字列で入力してください',
        'note.max' => '備考は255文字以内で入力してください',
    ];
}

public function withValidator($validator)
{
    $validator->after(function ($validator) {
        // 実働時間を超える休憩時間のチェック
        if ($this->corrected_clock_in && $this->corrected_clock_out && $this->corrected_break_time) {
            $clockIn = \Carbon\Carbon::parse($this->corrected_clock_in);
            $clockOut = \Carbon\Carbon::parse($this->corrected_clock_out);
            $totalMinutes = $clockIn->diffInMinutes($clockOut);
            
            list($hours, $minutes) = explode(':', $this->corrected_break_time);
            $breakMinutes = ($hours * 60) + $minutes;
            
            if ($breakMinutes > $totalMinutes) {
                $validator->errors()->add('corrected_break_time', '修正休憩時間は実働時間を超えることはできません');
            }
        }
    });
}
```

---

## 7. バリデーション実装の補足事項

### 7-1. FormRequestクラスの使用
すべてのバリデーションは、Laravelの`FormRequest`クラスを継承したカスタムRequestクラスで実装してください。

```php
php artisan make:request RegisterRequest
php artisan make:request LoginRequest
php artisan make:request AdminLoginRequest
php artisan make:request StampRequest
php artisan make:request CorrectionRequest
php artisan make:request ApprovalRequest
```

### 7-2. エラーメッセージの表示
エラーメッセージは、Bladeテンプレートで以下のように表示します。

```blade
@error('field_name')
    <div class="error">{{ $message }}</div>
@enderror
```

または、すべてのエラーをまとめて表示する場合:

```blade
@if ($errors->any())
    <div class="alert alert-danger">
        <ul>
            @foreach ($errors->all() as $error)
                <li>{{ $error }}</li>
            @endforeach
        </ul>
    </div>
@endif
```

### 7-3. カスタムバリデーションルール
打刻処理やステータス遷移など、複雑なバリデーションロジックについては、コントローラー内で追加のビジネスロジック検証を行う必要があります。

```php
// 例: StampRequestのafterフック
public function withValidator($validator)
{
    $validator->after(function ($validator) {
        // カスタムバリデーションロジック
        if ($this->stamp_type === 'clock_out' && !$this->hasClockIn()) {
            $validator->errors()->add('stamp_type', 'まだ出勤していません');
        }
    });
}
```

### 7-4. 日付形式のバリデーション
日時入力フィールドには、HTML5の`datetime-local`型を使用し、フォーマットは`Y-m-d\TH:i`で送信されることを想定しています。サーバー側では`Y-m-d H:i:s`形式に変換してデータベースに保存します。

---

## まとめ

本バリデーションルール一覧表は、機能要件一覧の以下の項目に対応しています:

- **FN002**: 会員登録のバリデーション
- **FN003**: 会員登録のエラーメッセージ表示
- **FN008**: ログインのバリデーション
- **FN009**: ログインのエラーメッセージ表示
- **FN015**: 管理者ログインのバリデーション
- **FN016**: 管理者ログインのエラーメッセージ表示
- **FN028**: 勤怠詳細編集時のバリデーション
- **FN029**: 打刻処理時のエラーメッセージ表示
- **FN030**: 修正申請時のバリデーション
- **FN040**: 承認処理時のバリデーション

各バリデーションルールは、FormRequestクラスとして実装し、適切なエラーメッセージを返すように設定してください。
